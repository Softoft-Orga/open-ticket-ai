open_ticket_ai:
  version: 1

  general_config:
    logging:
      version: 1
      disable_existing_loggers: false
      formatters:
        standard:
          format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
      handlers:
        console:
          class: "logging.StreamHandler"
          formatter: "standard"
          stream: "ext://sys.stdout"
      loggers:
        open_ticket_ai:
          handlers: [ "console" ]
          level: "INFO"
          propagate: false
      root:
        level: "INFO"
        handlers: [ "console" ]

  service_interfaces:
    TicketSystemService:
      methods:
        find:
          args:
            ticket_search_criteria: object
          returns: object
        update:
          args:
            ticket_id: string
            ticket: object
          returns: object
        add_note:
          args:
            ticket_id: string
            subject: string
            body: string
          returns: object
    TextClassifier:
      methods:
        classify:
          args:
            model: string
            prompt: string
            token_env: string
          returns:
            label: string
            confidence: number

  services:
    - id: otobo
      implements: TicketSystemService
      driver: otobo
      config:
        server_address: "http://212.19.58.44/znuny/nph-genericinterface.pl"
        webservice_name: "OpenTicketAI"
        search_operation_url: "ticket-search"
        update_operation_url: "ticket-update"
        get_operation_url: "ticket-get"
        username: "open_ticket_ai"
        password_env_var: "OTOBO_EHS_PASSWORD"
      provides: [ find, update, add_note ]

    - id: hf_local
      implements: TextClassifier
      driver: hf_local
      config: { }
      provides: [ classify ]

  pipe_defs:
    - id: classification_generic
      pipe: Composite
      params:
        model: ""
        token: ""
        prompt: ""
        map_obj: { }
        min_conf: 0.8
        low_conf_name: ""
        ticket_field: ""
        note_high: { subject: "", body: "" }
        note_low: { subject: "", body: "" }
        update_on_error: false
        error_note: { subject: "", body: "" }
        on_error_update_value: ""

      pipes:
        - name: classify
          pipe: ClassifierPipe
          services: { classifier: hf_local }
          params:
            model: "{{ params.model }}"
            token: "{{ params.token }}"
            prompt: "{{ params.prompt }}"
          output:
            data.cls:
              label: "{{ label }}"
              confidence: "{{ confidence }}"
            meta.events.success_full_prediction: "{{ label is defined and label|string|length > 0 }}"
            meta.events.classification_error: "{{ (label is not defined) or (errors|default([])|length > 0) }}"
            meta.events.timeout_error: "{{ timeout|default(false) }}"

        - name: map_value
          pipe: ContextModifier
          when: "has_event('success_full_prediction')"
          output:
            data.mapped_value: "{{ params.map_obj[data.cls.label] | default(data.cls.label) }}"
            meta.events.key_not_found: "{{ data.cls.label not in params.map_obj }}"

        - name: select_final
          pipe: ContextModifier
          when: "has_event('success_full_prediction') and not has_event('key_not_found')"
          output:
            data.final_value: |-
              {% if data.cls.confidence|float >= params.min_conf %}
                {{ data.mapped_value }}
              {% else %}
                {{ params.low_conf_name }}
              {% endif %}

        - name: update_ticket
          pipe: TicketUpdatePipe
          services: { target_ts: otobo_dest }
          when: "data.final_value"
          params:
            ticket_id: "{{ data.dest_ticket.id }}"
            ticket_field: "{{ params.ticket_field }}"
            ticket_value: "{{ data.final_value }}"
          output:
            meta.events.success_full_update: "{{ not failed|default(false) }}"

        - name: add_note_high
          pipe: TicketUpdatePipe
          services: { target_ts: otobo_dest }
          when: "has_event('success_full_update') and (data.cls.confidence|float >= params.min_conf)"
          params:
            ticket_id: "{{ data.dest_ticket.id }}"
            add_note:
              subject: "{{ params.note_high.subject }}"
              body: "{{ params.note_high.body }}"

        - name: add_note_low
          pipe: TicketUpdatePipe
          services: { target_ts: otobo_dest }
          when: "has_event('success_full_update') and (data.cls.confidence|float < params.min_conf)"
          params:
            ticket_id: "{{ data.dest_ticket.id }}"
            add_note:
              subject: "{{ params.note_low.subject }}"
              body: "{{ params.note_low.body }}"

        - name: update_on_error
          pipe: TicketUpdatePipe
          services: { target_ts: otobo_dest }
          when: "not has_event('success_full_update') and params.update_on_error"
          params:
            ticket_id: "{{ data.dest_ticket.id }}"
            ticket_field: "{{ params.ticket_field }}"
            ticket_value: "{{ params.on_error_update_value }}"
          output:
            meta.events.failed_error_update: "{{ failed|default(false) }}"

        - name: add_error_note
          pipe: TicketUpdatePipe
          services: { target_ts: otobo_dest }
          when: "not has_event('success_full_update') and not has_event('failed_error_update')"
          params:
            ticket_id: "{{ data.dest_ticket.id }}"
            add_note:
              subject: "{{ params.error_note.subject }}"
              body: "{{ params.error_note.body }}"



  pipelines:
    - id: ticket-routing
      default_services:
        TicketSystemService: otobo
        TextClassifier: hf_local
      pipeline_config:
        ticket_search_criteria:
          queue.name: "EingangsQueue"
          limit: 1
        min_queue_confidence: 0.8
        min_priority_confidence: 0.8
        queue_model: "softoft/EHS_Queue_V8"
        priority_model: "softoft/EHS_Priority_Prediction"
        low_confidence_queue_name: "Unklassifiziert"
        low_confidence_priority_name: "3 Mittel"
        queue_map:
          "Anfrage an die IT::Backup/Rücksicherung": "Anfrage an die IT::Backup/Rücksicherung"
          "Anfrage an die IT::Benutzer/Passwörter/Berechtigungen": "Anfrage an die IT::Benutzer/Passwörter/Berechtigungen"
          "Anfrage an die IT::DMS-System (d.3)": "Anfrage an die IT::DMS-System (d.3)"
          "Anfrage an die IT::Drucker": "Anfrage an die IT::Drucker"
          "Anfrage an die IT::ERP-System (Wilken/eGecko)": "Anfrage an die IT::ERP-System (Wilken/eGecko)"
          "Anfrage an die IT::Fachsystem Pflege": "Anfrage an die IT::Fachsystem Pflege"
          "Anfrage an die IT::Homeoffice": "Anfrage an die IT::Homeoffice"
          "Anfrage an die IT::Logbuch/Sharepoint": "Anfrage an die IT::Logbuch/Sharepoint"
          "Anfrage an die IT::Mail/Outlook": "Anfrage an die IT::Mail/Outlook"
          "Anfrage an die IT::PC/Hardware": "Anfrage an die IT::PC/Hardware"
          "Anfrage an die IT::Smartphone/Tablet": "Anfrage an die IT::Smartphone/Tablet"
          "Anfrage an die IT::Software-Bestellungen": "Anfrage an die IT::Software-Bestellungen"
          "Anfrage an die IT::Sonstige Systeme/Anwendungen": "Anfrage an die IT::Sonstige Systeme/Anwendungen"
          "Anfrage an die IT::TK-Anlagen/Nebenstellen": "Anfrage an die IT::TK-Anlagen/Nebenstellen"
          "Anfrage an die IT::Netzwerk/Internet": "Anfrage an die IT::Netzwerk/Internet"
          "Assistenzsysteme": "Assistenzsysteme"
          "Bewerbungsmanagement": "Bewerbungsmanagement"
          "Hausnotruf": "Hausnotruf"
          "Hauswirtschaft": "Hauswirtschaft"
          "Hygiene": "Hygiene"
          "Lernwelt": "Lernwelt"
          "Personal Office": "Personal Office"
          "Pflege und Alltagsbegleitung": "Pflege und Alltagsbegleitung"
        priority_map:
          "1 Kritisch": "1 Kritisch"
          "3 Mittel": "3 Mittel"
          "5 Sehr niedrig": "5 Sehr niedrig"

      steps:
        - name: ticket_fetcher
          pipe: TicketFetchPipe
          use: otobo
          params:
            ticket_search_criteria: "{{ pipeline_config.ticket_search_criteria }}"
          output:
            data.ticket: "{{ current_state.found_tickets | first }}"

        - name: queue_classification
          pipe: Composite
          use_def: classification_generic
          params:
            service_alias: otobo
            classifier_alias: hf_local
            model: "{{ pipeline_config.queue_model }}"
            token: "{{ env.OTAI_HUGGINGFACE_EHS_TOKEN }}"
            prompt: "{{ data.ticket.subject }} {{ data.ticket.body }}"
            map_obj: "{{ pipeline_config.queue_map }}"
            min_conf: "{{ pipeline_config.min_queue_confidence }}"
            low_conf_name: "{{ pipeline_config.low_confidence_queue_name }}"
            ticket_field: "queue.name"
            success_full_high_confidence_note:
              subject: "Automatische Klassifizierung"
              body: |
                Das Ticket wurde automatisch der Queue {{ data.final_queue }} zugeordnet;
                mit der Konfidenz {{ data.queue_prediction.confidence }}
            success_full_low_confidence_note:
              subject: "Automatische Klassifizierung"
              body: |
                Das Ticket wurde automatisch der Queue {{ data.final_queue }} zugeordnet;
                da die Konfidenz {{ data.queue_prediction.confidence }} zu gering ist.
                Mindest Konfidenz {{ pipeline_config.min_queue_confidence }}

            update_on_error: true
            on_error_update_value: "{{ pipeline_config.error_queue_name }}"
            error_note:
              subject: ""
              body: |
                Das Ticket konnte nicht automatisch der Queue zugeordnet werden;
                Da ein Fehler aufgetreten ist.
                Wurde in die Queue {{ pipeline_config.error_queue_name }} verschoben.


        - name: priority_classification
          pipe: Composite
          use_def: classification_generic
          params:
            service_alias: otobo
            classifier_alias: hf_local
            model: "{{ pipeline_config.priority_model }}"
            token_env: "HUGGINGFACE_EHS_TOKEN"
            prompt_tmpl: "{{ data.ticket.subject }} {{ data.ticket.body }}"
            map_obj: "{{ pipeline_config.priority_map }}"
            min_conf: "{{ pipeline_config.min_priority_confidence }}"
            low_conf_name: "{{ pipeline_config.low_confidence_priority_name }}"
            ticket_field: "priority.name"
            success_full_high_confidence_note:
              subject: "Automatische Priorisierung"
              body: |
                Das Ticket wurde automatisch der Priorität {{ data.final_value }} zugeordnet;
                mit der Konfidenz {{ current_state.cls.confidence }}"
            success_full_low_confidence_note:
              subject: "Automatische Priorisierung"
              body: |
                Das Ticket wurde automatisch der Priorität {{ data.final_value }} zugeordnet;
                da die Konfidenz {{ current_state.cls.confidence }} zu gering ist.
                Mindest Konfidenz {{ pipeline_config.min_priority_confidence }}
            update_on_error: false
            error_note:
              subject: "Automatische Priorisierung"
              body: |
                Das Ticket konnte nicht automatisch der Priorität zugeordnet werden;
                Da ein Fehler aufgetreten ist.

  orchestrator:
    run_every_milli_seconds: 10000
