name: Copilot PR Retry Handler

on:
    pull_request:
        types: [opened, synchronize, reopened]
    workflow_run:
        workflows: ["CI Quality Assurance", "Trivy Security Scan"]
        types:
            - completed

permissions:
    contents: read
    pull-requests: write
    issues: write
    checks: read

jobs:
    copilot-retry-handler:
        name: Handle Copilot PR Failures
        runs-on: ubuntu-latest
        if: |
            (github.event_name == 'pull_request' && github.actor == 'github-copilot[bot]') ||
            (github.event_name == 'workflow_run' && github.event.workflow_run.head_repository.owner.login == github.repository_owner)
        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Get PR information
                id: pr-info
                uses: actions/github-script@v7
                with:
                    script: |
                        let prNumber;
                        let headSha;
                        
                        if (context.eventName === 'pull_request') {
                            prNumber = context.payload.pull_request.number;
                            headSha = context.payload.pull_request.head.sha;
                        } else if (context.eventName === 'workflow_run') {
                            const workflowRun = context.payload.workflow_run;
                            headSha = workflowRun.head_sha;
                            
                            // Find PR associated with this workflow run
                            const prs = await github.rest.pulls.list({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                state: 'open',
                                head: `${context.repo.owner}:${workflowRun.head_branch}`
                            });
                            
                            if (prs.data.length === 0) {
                                core.info('No open PR found for this workflow run');
                                return;
                            }
                            
                            prNumber = prs.data[0].number;
                        }
                        
                        if (!prNumber) {
                            core.info('Unable to determine PR number');
                            return;
                        }
                        
                        // Get PR details
                        const pr = await github.rest.pulls.get({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            pull_number: prNumber
                        });
                        
                        const isCopilotPR = pr.data.user.login === 'github-copilot[bot]';
                        
                        core.setOutput('pr_number', prNumber);
                        core.setOutput('head_sha', headSha);
                        core.setOutput('is_copilot_pr', isCopilotPR);
                        core.setOutput('pr_url', pr.data.html_url);
                        
                        core.info(`PR #${prNumber}: ${pr.data.title}`);
                        core.info(`Author: ${pr.data.user.login}`);
                        core.info(`Is Copilot PR: ${isCopilotPR}`);

            -   name: Check workflow status
                id: check-status
                if: steps.pr-info.outputs.is_copilot_pr == 'true'
                uses: actions/github-script@v7
                with:
                    script: |
                        const prNumber = ${{ steps.pr-info.outputs.pr_number }};
                        const headSha = '${{ steps.pr-info.outputs.head_sha }}';
                        
                        if (!prNumber || !headSha) {
                            core.info('Missing PR number or head SHA');
                            return;
                        }
                        
                        // Get all check runs for this commit
                        const checkRuns = await github.rest.checks.listForRef({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            ref: headSha
                        });
                        
                        // Get all statuses for this commit
                        const statuses = await github.rest.repos.getCombinedStatusForRef({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            ref: headSha
                        });
                        
                        const failedChecks = [];
                        const allChecks = [];
                        
                        // Check GitHub Actions check runs
                        for (const check of checkRuns.data.check_runs) {
                            allChecks.push({
                                name: check.name,
                                status: check.status,
                                conclusion: check.conclusion
                            });
                            
                            if (check.status === 'completed' && check.conclusion === 'failure') {
                                failedChecks.push(check.name);
                            }
                        }
                        
                        // Check commit statuses
                        for (const status of statuses.data.statuses) {
                            allChecks.push({
                                name: status.context,
                                state: status.state
                            });
                            
                            if (status.state === 'failure' || status.state === 'error') {
                                failedChecks.push(status.context);
                            }
                        }
                        
                        const hasFailures = failedChecks.length > 0;
                        const overallState = statuses.data.state;
                        
                        core.setOutput('has_failures', hasFailures);
                        core.setOutput('failed_checks', failedChecks.join(', '));
                        core.setOutput('overall_state', overallState);
                        
                        core.info(`Overall status: ${overallState}`);
                        core.info(`Total checks: ${allChecks.length}`);
                        core.info(`Failed checks: ${failedChecks.length}`);
                        
                        if (hasFailures) {
                            core.warning(`Failed checks: ${failedChecks.join(', ')}`);
                        }

            -   name: Label PR as retry-needed
                if: |
                    steps.pr-info.outputs.is_copilot_pr == 'true' &&
                    steps.check-status.outputs.has_failures == 'true'
                uses: actions/github-script@v7
                with:
                    script: |
                        const prNumber = ${{ steps.pr-info.outputs.pr_number }};
                        
                        // Add retry-needed label
                        try {
                            await github.rest.issues.addLabels({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                issue_number: prNumber,
                                labels: ['retry-needed', 'copilot-pr']
                            });
                            core.info(`Added 'retry-needed' label to PR #${prNumber}`);
                        } catch (error) {
                            core.warning(`Failed to add label: ${error.message}`);
                        }

            -   name: Comment on PR with failure details
                if: |
                    steps.pr-info.outputs.is_copilot_pr == 'true' &&
                    steps.check-status.outputs.has_failures == 'true'
                uses: actions/github-script@v7
                with:
                    script: |
                        const prNumber = ${{ steps.pr-info.outputs.pr_number }};
                        const failedChecks = '${{ steps.check-status.outputs.failed_checks }}';
                        const prUrl = '${{ steps.pr-info.outputs.pr_url }}';
                        
                        const commentBody = `## ⚠️ Copilot PR Retry Required
                        
                        This Copilot-generated PR has failed one or more required checks.
                        
                        **Failed Checks:**
                        ${failedChecks.split(', ').map(check => `- ${check}`).join('\n')}
                        
                        **Next Steps:**
                        - This PR has been labeled with \`retry-needed\`
                        - The PR will be closed to allow Copilot to retry with fixes
                        - Review the check failures above to understand what needs to be addressed
                        
                        **Automation Status:** This is an automated response from the Copilot PR Retry Handler workflow.`;
                        
                        await github.rest.issues.createComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: prNumber,
                            body: commentBody
                        });
                        
                        core.info(`Posted failure comment on PR #${prNumber}`);

            -   name: Close PR with failure
                if: |
                    steps.pr-info.outputs.is_copilot_pr == 'true' &&
                    steps.check-status.outputs.has_failures == 'true'
                uses: actions/github-script@v7
                with:
                    script: |
                        const prNumber = ${{ steps.pr-info.outputs.pr_number }};
                        
                        await github.rest.pulls.update({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            pull_number: prNumber,
                            state: 'closed'
                        });
                        
                        core.info(`Closed PR #${prNumber} due to failed checks`);
                        core.notice(`Copilot PR #${prNumber} was closed due to failed checks. Copilot can now retry.`);

            -   name: Log success for passing Copilot PR
                if: |
                    steps.pr-info.outputs.is_copilot_pr == 'true' &&
                    steps.check-status.outputs.has_failures != 'true' &&
                    steps.check-status.outputs.overall_state == 'success'
                uses: actions/github-script@v7
                with:
                    script: |
                        const prNumber = ${{ steps.pr-info.outputs.pr_number }};
                        
                        // Add copilot-pr label for tracking
                        try {
                            await github.rest.issues.addLabels({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                issue_number: prNumber,
                                labels: ['copilot-pr']
                            });
                        } catch (error) {
                            core.warning(`Failed to add label: ${error.message}`);
                        }
                        
                        core.info(`Copilot PR #${prNumber} has passing checks ✓`);
