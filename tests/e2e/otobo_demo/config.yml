$schema: "./config.schema.json"

definitions:
    - &ticket_fetch_pipe
        use: "open_ticket_ai.base:FetchTicketsPipe"
    - &ticket_update_pipe
        use: "open_ticket_ai.base:UpdateTicketsPipe"
    - &ticket_add_note_pipe
        use: "open_ticket_ai.base:AddNoteTicketsPipe"
    - &ticket_classifier_pipe
        use: "open_ticket_ai_hf_local:HFLocalTextClassificationPipe"
    - &jinja_expression_pipe
        use: "open_ticket_ai.base:JinjaExpressionPipe"
    - &default_ticket_update
        <<: *ticket_update_pipe
        injects: { ticket_system: "otobo_znuny" }
        ticket_id: "{{ config.ticket.id }}"

    - &default_ticket_add_note
        <<: *ticket_add_note_pipe
        injects: { ticket_system: "otobo_znuny" }
        ticket_id: "{{ config.ticket.id }}"

    - &ticket_classifier
        <<: *ticket_classifier_pipe
    - &classification_generic
        steps:
            -   id: classify
                <<: *ticket_classifier
                model: "{{ config.model }}"
                prompt: "{{ config.ticket.subject }} {{ config.ticket.body }}"

            -   id: select_final
                <<: *jinja_expression_pipe
                expression: |-
                    {%- set label = pipe_result('classify','label') -%}
                    {%- set mapped = (config.map_obj or {}).get(label, label) -%}
                    {%- set has_high_confidence = pipe_result('classify','confidence') >= config.min_conf -%}
                    {{ mapped if has_high_confidence else config.low_conf_name }}
                depends_on: [ "classify" ]

            -   id: update_ticket
                <<: *default_ticket_update
                updated_ticket: "{{ pipe_result('select_final') | at_path(config.ticket_field) }}"
                depends_on: [ "select_final" ]

            -   id: add_note
                <<: *default_ticket_add_note
                note: |
                    {{
                      config.note_high if pipe_result('classify','confidence') >= config.min_conf
                      else config.note_low
                    }}
                depends_on: [ "update_ticket" ]

            -   if: "{{ has_failed('update_ticket') and config.update_on_error }}"
                <<: *default_ticket_update
                updated_ticket: "{{ config.on_error_update_value | at_path(config.ticket_field) }}"
                depends_on: [ "update_ticket" ]

            -   if: "{{ has_failed('update_ticket') and config.error_note }}"
                <<: *default_ticket_add_note
                note: "{{ config.error_note }}"
                depends_on: [ "update_ticket" ]
open_ticket_ai:
    general_config:
        logging:
            version: 1
            disable_existing_loggers: false
            handlers: { console: { class: logging.StreamHandler, stream: ext://sys.stdout } }
            formatters: { std: { format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s" } }
            root: { level: INFO, handlers: [ console ] }

        template_renderer:
            type: "jinja"
            params:
                env_prefix: "OTAI_"
                env_key: "env"
    defs:
        -   id: "otobo_znuny"
            use: "open_ticket_ai_otobo_znuny_plugin:OTOBOZnunyTicketSystemService"
            base_url: "http://52.57.217.182/otobo/nph-genericinterface.pl"
            password: "{{ env.OTAI_OTOBO_ZNUNY_PASSWORD }}"

    orchestrator:
        -   run_every_milli_seconds: 100_000
            pipe:
                id: ticket-routing
                ticket_search_criteria:
                    queue.name: "OpenTicketAI::Incoming"
                    limit: 1
                min_queue_confidence: 0.8
                min_priority_confidence: 0.8
                queue_model: "softoft/otai-queue-de-bert-v1"
                priority_model: "softoft/otai-priority-de-bert-v1"
                low_confidence_queue_name: "OpenTicketAI::Unclassified"
                error_queue_name: "OpenTicketAI::Error"
                low_confidence_priority_name: "medium"
                steps:
                    -   id: ticket_fetcher
                        <<: *ticket_fetch_pipe
                        injects: { ticket_system: "otobo_znuny" }
                        ticket_search_criteria: "{{ config.ticket_search_criteria }}"

                    -   if: "{{ (pipe_result('ticket_fetcher') | length) > 0 }}"
                        id: queue_classification
                        depends_on: [ "ticket_fetcher" ]
                        <<: *classification_generic
                        model: "{{ config.queue_model }}"
                        ticket: "{{ pipe_result('ticket_fetcher') | first }}"
                        min_conf: "{{ config.min_queue_confidence }}"
                        low_conf_name: "{{ config.low_confidence_queue_name }}"
                        ticket_field: "queue.name"
                        success_full_high_confidence_note:
                            subject: "Automatische Klassifizierung"
                            body: |
                                Das Ticket wurde automatisch der Queue {{ pipe_result('select_final') }} zugeordnet;
                                mit der Konfidenz {{ pipe_result('classify','confidence') }}
                        success_full_low_confidence_note:
                            subject: "Automatische Klassifizierung"
                            body: |
                                Das Ticket wurde automatisch der Queue {{ pipe_result('select_final') }} zugeordnet;
                                da die Konfidenz {{ pipe_result('classify','confidence') }} zu gering ist.
                                Mindest Konfidenz {{ config.min_queue_confidence }}

                        update_on_error: true
                        on_error_update_value: "{{ config.error_queue_name }}"
                        error_note:
                            subject: ""
                            body: |
                                Das Ticket konnte nicht automatisch der Queue zugeordnet werden;
                                Da ein Fehler aufgetreten ist.
                                Wurde in die Queue {{ config.error_queue_name }} verschoben.

                    -   if: "{{ (pipe_result('ticket_fetcher') | length) > 0 }}"
                        id: priority_classification
                        depends_on: [ "ticket_fetcher" ]
                        <<: *classification_generic
                        ticket: "{{ pipe_result('ticket_fetcher') | first }}"
                        model: "{{ config.priority_model }}"
                        min_conf: "{{ config.min_priority_confidence }}"
                        low_conf_name: "{{ config.low_confidence_priority_name }}"
                        ticket_field: "priority.name"
                        success_full_high_confidence_note:
                            subject: "Automatische Priorisierung"
                            body: |
                                Das Ticket wurde automatisch der Priorität {{ pipe_result('select_final') }} zugeordnet;
                                mit der Konfidenz {{ pipe_result('classify','confidence') }}
                        success_full_low_confidence_note:
                            subject: "Automatische Priorisierung"
                            body: |
                                Das Ticket wurde automatisch der Priorität {{ pipe_result('select_final') }} zugeordnet;
                                da die Konfidenz {{ pipe_result('classify','confidence') }} zu gering ist.
                                Mindest Konfidenz {{ config.min_priority_confidence }}
                        error_note:
                            subject: "Automatische Priorisierung"
                            body: |
                                Das Ticket konnte nicht automatisch der Priorität zugeordnet werden;
                                Da ein Fehler aufgetreten ist.

