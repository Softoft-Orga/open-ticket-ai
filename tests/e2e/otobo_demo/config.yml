open_ticket_ai:
  api_version: 1
  infrastructure:
    logging:
      version: 1
      disable_existing_loggers: false
      formatters:
        std:
          format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
      handlers:
        console:
          class: logging.StreamHandler
          stream: ext://sys.stdout
          formatter: std
      root:
        level: DEBUG
        handlers: [ console ]
    default_template_renderer: "jinja_default"

  services:
    jinja_default:
      use: "open_ticket_ai.JinjaRenderer"

    otobo_znuny:
      use: "otai_otobo_znuny.OTOBOZnunyTicketSystemService"
      params:
        base_url: "http://52.57.217.182/otobo/nph-genericinterface.pl"

    hf_local:
      use: "otai_hf_local.HFLocalService"

  orchestrator:
    use: "open_ticket_ai.SimpleSequentialOrchestrator"
    steps:
      id: ticket-routing-runner
      use: "open_ticket_ai.SimpleSequentialRunner"
      params:
        "on":
          - id: "every_10ms"
            use: "open_ticket_ai.IntervalTrigger"
            params:
              milliseconds: 10000
        run:
          id: ticket-routing
          params:
            ticket_search_criteria:
              queue:
                name: "OpenTicketAI::Incoming"
              limit: 1
            min_queue_confidence: 0.8
            min_priority_confidence: 0.8
            queue_model: "softoft/otai-queue-de-bert-v1"
            priority_model: "softoft/otai-priority-de-bert-v1"
            low_confidence_queue_name: "OpenTicketAI::Unclassified"
            error_queue_name: "OpenTicketAI::Error"
            low_confidence_priority_name: "medium"
          steps:
            # ===== FETCHING TICKET BY QUEUE =========
            - id: ticket_fetcher
              use: "open_ticket_ai.FetchTicketsPipe"
              injects: { ticket_system: "otobo_znuny" }
              params:
                ticket_search_criteria: "{{ parent['ticket_search_criteria'] }}"

            # ===== QUEUE CLASSIFICATION =========

            - if: "{{ (pipe_result('ticket_fetcher') | length) > 0 }}"
              id: queue_classification
              params:
                model: "{{ parent['queue_model'] }}"
                min_conf: "{{ parent['min_queue_confidence'] }}"
                low_conf_name: "{{ parent['low_confidence_queue_name'] }}"
                ticket_field: "queue.name"
                note_high: "{{ parent['success_full_high_confidence_note'] }}"
                note_low: "{{ parent['success_full_low_confidence_note'] }}"
                update_on_error: true
                on_error_update_value: "{{ parent['error_queue_name'] }}"
                error_note: "{{ parent['error_note'] }}"
              steps:
                - id: classify
                  use: "otai_hf_local.HFLocalTextClassificationPipe"
                  params:
                    model: "{{ parent['model'] }}"
                    prompt: "{{ parent['ticket']['subject'] }} {{ parent['ticket']['body'] }}"
                  retry:
                    on:
                      - "TimeoutError"
                      - "requests.exceptions.RequestException"
                - id: select_final
                  use: "open_ticket_ai.ExpressionPipe"
                  params:
                    expression: |-
                      {%- set label = pipe_result('classify','label') -%}
                      {%- set mapped = (params['map_obj'] or {}).get(label, label) -%}
                      {%- set has_high_confidence = pipe_result('classify','confidence') >= params['min_conf'] -%}
                      {{ mapped if has_high_confidence else params['low_conf_name'] }}
                - id: update_ticket
                  use: "open_ticket_ai.UpdateTicketPipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ parent['ticket']['id'] }}"
                    updated_ticket: "{{ pipe_result('select_final') | at_path(params['ticket_field']) }}"
                - id: add_note
                  use: "open_ticket_ai.AddNotePipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ parent['ticket']['id'] }}"
                    note: |
                      {{
                        params['note_high'] if pipe_result('classify','confidence') >= params['min_conf']
                        else params['note_low']
                      }}
                - if: "{{ has_failed('update_ticket') and params['update_on_error'] }}"
                  use: "open_ticket_ai.UpdateTicketPipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ params['ticket']['id'] }}"
                    updated_ticket: "{{ params['on_error_update_value'] | at_path(params['ticket_field']) }}"
                - if: "{{ has_failed('update_ticket') and params['error_note'] }}"
                  use: "open_ticket_ai.AddNotePipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ params['ticket']['id'] }}"
                    note: "{{ params['error_note'] }}"

            # ===== PRIORITY CLASSIFICATION =========

            - if: "{{ (pipe_result('ticket_fetcher') | length) > 0 }}"
              id: priority_classification
              params:
                depends_on: [ "ticket_fetcher" ]
                ticket: "{{ pipe_result('ticket_fetcher') | first }}"
                model: "{{ parent['priority_model'] }}"
                min_conf: "{{ parent['min_priority_confidence'] }}"
                low_conf_name: "{{ parent['low_confidence_priority_name'] }}"
                ticket_field: "priority.name"
                success_full_high_confidence_note:
                  subject: "Automatische Priorisierung"
                  body: |
                    Das Ticket wurde automatisch der Priorität {{ pipe_result('select_final') }} zugeordnet;
                    mit der Konfidenz {{ pipe_result('classify','confidence') }}
                success_full_low_confidence_note:
                  subject: "Automatische Priorisierung"
                  body: |
                    Das Ticket wurde automatisch der Priorität {{ pipe_result('select_final') }} zugeordnet;
                    da die Konfidenz {{ pipe_result('classify','confidence') }} zu gering ist.
                    Mindest Konfidenz {{ params['min_priority_confidence'] }}
                error_note:
                  subject: "Automatische Priorisierung"
                  body: |
                    Das Ticket konnte nicht automatisch der Priorität zugeordnet werden;
                    Da ein Fehler aufgetreten ist.
                update_on_error: true
                on_error_update_value: "{{ parent['error_queue_name'] }}"
              steps:
                - id: classify
                  use: "otai_hf_local.HFLocalTextClassificationPipe"
                  params:
                    model: "{{ parent['model'] }}"
                    prompt: "{{ parent['ticket']['subject'] }} {{ parent['ticket']['body'] }}"
                    on:
                      - "TimeoutError"
                      - "requests.exceptions.RequestException"
                - id: select_final
                  use: "open_ticket_ai.ExpressionPipe"
                  params:
                    expression: |-
                      {%- set label = pipe_result('classify','label') -%}
                      {%- set mapped = (params['map_obj'] or {}).get(label, label) -%}
                      {%- set has_high_confidence = pipe_result('classify','confidence') >= params['min_conf'] -%}
                      {{ mapped if has_high_confidence else params['low_conf_name'] }}
                - id: update_ticket
                  use: "open_ticket_ai.UpdateTicketPipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ parent['ticket']['id'] }}"
                    updated_ticket: "{{ pipe_result('select_final') | at_path(params['ticket_field']) }}"
                - id: add_note
                  use: "open_ticket_ai.AddNotePipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ parent['ticket']['id'] }}"
                    note: |
                      {{
                        params['note_high'] if pipe_result('classify','confidence') >= params['min_conf']
                        else params['note_low']
                      }}
                - if: "{{ has_failed('update_ticket') and params['update_on_error'] }}"
                  use: "open_ticket_ai.UpdateTicketPipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ params['ticket']['id'] }}"
                    updated_ticket: "{{ params['on_error_update_value'] | at_path(params['ticket_field']) }}"
                - if: "{{ has_failed('update_ticket') and params['error_note'] }}"
                  use: "open_ticket_ai.AddNotePipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ params['ticket']['id'] }}"
                    note: "{{ params['error_note'] }}"