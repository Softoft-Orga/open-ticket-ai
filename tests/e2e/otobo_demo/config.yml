open_ticket_ai:
  infrastructure:
    logging:
      version: 1
      disable_existing_loggers: false
      formatters:
        std:
          format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
      handlers:
        console:
          class: logging.StreamHandler
          stream: ext://sys.stdout
          formatter: std
      root:
        level: DEBUG
        handlers: [console]
    default_template_renderer: "jinja_default"

  services:
    - id: "jinja_default"
      use: "open_ticket_ai.base.template_renderers.jinja_renderer:JinjaRenderer"
      params:
        env_config:
          prefix: "OTAI_"
        autoescape: false

    - id: "otobo_znuny"
      use: "otai_otobo_znuny.oto_znuny_ts_service:OTOBOZnunyTicketSystemService"
      params:
        base_url: "http://52.57.217.182/otobo/nph-genericinterface.pl"
        password: "{{ env.OTAI_OTOBO_ZNUNY_PASSWORD }}"

  orchestrator:
    defaults:
      template_renderer: "jinja_template_renderer"
      pipe_defaults:
        retry:
          attempts: 1
          delay: 0
    runners:
      - "on":
          - id: "every_10ms"
            use: "open_ticket_ai.base.triggers.interval_trigger:IntervalTrigger"
            params:
              milliseconds: 100000
        run:
          id: ticket-routing
          params:
            ticket_search_criteria:
              queue:
                name: "OpenTicketAI::Incoming"
              limit: 1
            min_queue_confidence: 0.8
            min_priority_confidence: 0.8
            queue_model: "softoft/otai-queue-de-bert-v1"
            priority_model: "softoft/otai-priority-de-bert-v1"
            low_confidence_queue_name: "OpenTicketAI::Unclassified"
            error_queue_name: "OpenTicketAI::Error"
            low_confidence_priority_name: "medium"
          steps:
            # ===== FETCHING TICKET BY QUEUE =========
            - id: ticket_fetcher
              use: "open_ticket_ai.base.pipes.ticket_system_pipes.fetch_tickets_pipe:FetchTicketsPipe"
              injects: { ticket_system: "otobo_znuny" }
              params:
                search_criteria: "{{ parent.params.ticket_search_criteria }}"

            # ===== QUEUE CLASSIFICATION =========

            - if: "{{ (pipe_result('ticket_fetcher') | length) > 0 }}"
              id: queue_classification
              params:
                model: "{{ parent.params.queue_model }}"
                min_conf: "{{ parent.params.min_queue_confidence }}"
                low_conf_name: "{{ parent.params.low_confidence_queue_name }}"
                ticket_field: "queue.name"
                note_high: "{{ parent.params.success_full_high_confidence_note }}"
                note_low: "{{ parent.params.success_full_low_confidence_note }}"
                update_on_error: true
                on_error_update_value: "{{ parent.params.error_queue_name }}"
                error_note: "{{ parent.params.error_note }}"
              steps:
                - id: classify
                  use: "otai_hf_local.hf_local_text_classification_pipe:HFLocalTextClassificationPipe"
                  params:
                    model: "{{ parent.params.model }}"
                    prompt: "{{ parent.params.ticket.subject }} {{ parent.params.ticket.body }}"
                  retry:
                    attempts: 2
                    on:
                      - "TimeoutError"
                      - "requests.exceptions.RequestException"
                    delay: 2
                - id: select_final
                  use: "open_ticket_ai.base.pipes.expression_pipe:ExpressionPipe"
                  params:
                    expression: |-
                      {%- set label = pipe_result('classify','label') -%}
                      {%- set mapped = (params.map_obj or {}).get(label, label) -%}
                      {%- set has_high_confidence = pipe_result('classify','confidence') >= params.min_conf -%}
                      {{ mapped if has_high_confidence else params.low_conf_name }}
                - id: update_ticket
                  use: "open_ticket_ai.base.pipes.ticket_system_pipes.update_ticket_pipe:UpdateTicketPipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ parent.params.ticket.id }}"
                    updated_ticket: "{{ pipe_result('select_final') | at_path(params.ticket_field) }}"
                - id: add_note
                  use: "open_ticket_ai.base.pipes.ticket_system_pipes.add_note_pipe:AddNotePipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ parent.params.ticket.id }}"
                    note: |
                      {{
                        params.note_high if pipe_result('classify','confidence') >= params.min_conf
                        else params.note_low
                      }}
                - if: "{{ has_failed('update_ticket') and params.update_on_error }}"
                  use: "open_ticket_ai.base.pipes.ticket_system_pipes.update_ticket_pipe:UpdateTicketPipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ params.ticket.id }}"
                    updated_ticket: "{{ params.on_error_update_value | at_path(params.ticket_field) }}"
                - if: "{{ has_failed('update_ticket') and params.error_note }}"
                  use: "open_ticket_ai.base.pipes.ticket_system_pipes.add_note_pipe:AddNotePipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ params.ticket.id }}"
                    note: "{{ params.error_note }}"

            # ===== PRIORITY CLASSIFICATION =========

            - if: "{{ (pipe_result('ticket_fetcher') | length) > 0 }}"
              id: priority_classification
              params:
                depends_on: [ "ticket_fetcher" ]
                ticket: "{{ pipe_result('ticket_fetcher') | first }}"
                model: "{{ parent.params.priority_model }}"
                min_conf: "{{ parent.params.min_priority_confidence }}"
                low_conf_name: "{{ parent.params.low_confidence_priority_name }}"
                ticket_field: "priority.name"
                success_full_high_confidence_note:
                  subject: "Automatische Priorisierung"
                  body: |
                    Das Ticket wurde automatisch der Priorität {{ pipe_result('select_final') }} zugeordnet;
                    mit der Konfidenz {{ pipe_result('classify','confidence') }}
                success_full_low_confidence_note:
                  subject: "Automatische Priorisierung"
                  body: |
                    Das Ticket wurde automatisch der Priorität {{ pipe_result('select_final') }} zugeordnet;
                    da die Konfidenz {{ pipe_result('classify','confidence') }} zu gering ist.
                    Mindest Konfidenz {{ params.min_priority_confidence }}
                error_note:
                  subject: "Automatische Priorisierung"
                  body: |
                    Das Ticket konnte nicht automatisch der Priorität zugeordnet werden;
                    Da ein Fehler aufgetreten ist.
                update_on_error: true
                on_error_update_value: "{{ parent.params.error_queue_name }}"
              steps:
                - id: classify
                  use: "otai_hf_local.hf_local_text_classification_pipe:HFLocalTextClassificationPipe"
                  params:
                    model: "{{ parent.params.model }}"
                    prompt: "{{ parent.params.ticket.subject }} {{ parent.params.ticket.body }}"
                  retry:
                    attempts: 2
                    on:
                      - "TimeoutError"
                      - "requests.exceptions.RequestException"
                    delay: 2
                - id: select_final
                  use: "open_ticket_ai.base.pipes.expression_pipe:ExpressionPipe"
                  params:
                    expression: |-
                      {%- set label = pipe_result('classify','label') -%}
                      {%- set mapped = (params.map_obj or {}).get(label, label) -%}
                      {%- set has_high_confidence = pipe_result('classify','confidence') >= params.min_conf -%}
                      {{ mapped if has_high_confidence else params.low_conf_name }}
                - id: update_ticket
                  use: "open_ticket_ai.base.pipes.ticket_system_pipes.update_ticket_pipe:UpdateTicketPipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ parent.params.ticket.id }}"
                    updated_ticket: "{{ pipe_result('select_final') | at_path(params.ticket_field) }}"
                - id: add_note
                  use: "open_ticket_ai.base.pipes.ticket_system_pipes.add_note_pipe:AddNotePipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ parent.params.ticket.id }}"
                    note: |
                      {{
                        params.note_high if pipe_result('classify','confidence') >= params.min_conf
                        else params.note_low
                      }}
                - if: "{{ has_failed('update_ticket') and params.update_on_error }}"
                  use: "open_ticket_ai.base.pipes.ticket_system_pipes.update_ticket_pipe:UpdateTicketPipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ params.ticket.id }}"
                    updated_ticket: "{{ params.on_error_update_value | at_path(params.ticket_field) }}"
                - if: "{{ has_failed('update_ticket') and params.error_note }}"
                  use: "open_ticket_ai.base.pipes.ticket_system_pipes.add_note_pipe:AddNotePipe"
                  injects: { ticket_system: "otobo_znuny" }
                  params:
                    ticket_id: "{{ params.ticket.id }}"
                    note: "{{ params.error_note }}"
        retry:
          attempts: 0
          delay: 0
        timeout: "10s"
        priority: 10
        concurrency:
          max_workers: 1
          when_exhausted: "wait"
