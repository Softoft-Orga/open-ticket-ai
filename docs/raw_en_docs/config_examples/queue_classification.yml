# Example: AI-Powered Queue Classification
#
# This configuration demonstrates automatic ticket routing to appropriate queues
# based on AI analysis of ticket content. The AI classifies tickets into
# categories like IT, HR, Finance, General Support, etc.

open_ticket_ai:
    general_config:
        logging:
            version: 1
            disable_existing_loggers: false
            handlers:
                console:
                    class: logging.StreamHandler
                    stream: ext://sys.stdout
            formatters:
                std:
                    format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
            root:
                level: INFO
                handlers: [ console ]

        pipe_classes:
            - &ticket_fetch_pipe
                use: "open_ticket_ai.base:FetchTicketsPipe"
            - &ticket_update_pipe
                use: "open_ticket_ai.base:UpdateTicketsPipe"
            - &ticket_add_note_pipe
                use: "open_ticket_ai.base:AddNoteTicketsPipe"
            - &ticket_classifier_pipe
                use: "open_ticket_ai.otai_hf_local:HFLocalTextClassificationPipe"
            - &jinja_expression_pipe
                use: "open_ticket_ai.base:JinjaExpressionPipe"

    services:
        # Ticket system connection
        -   id: "otobo_znuny"
            use: "open_ticket_ai.otai_otobo_znuny:OToboZnunyTicketSystemService"
            server_address: "{{ env.OTAI_OTOBO_ZNUNY_SERVER_ADDRESS }}"
            password: "{{ env.OTAI_OTOBO_ZNUNY_PASSWORD }}"

        # Default ticket update pipe
        - &default_ticket_update
            <<: *ticket_update_pipe
            injects: { ticket_system: "otobo_znuny" }
            ticket_id: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | first).id }}"

        # Default note addition pipe
        - &default_ticket_add_note
            <<: *ticket_add_note_pipe
            injects: { ticket_system: "otobo_znuny" }
            ticket_id: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | first).id }}"

        # AI classifier for queue routing
        - &queue_classifier
            <<: *ticket_classifier_pipe
            token: "{{ env.OTAI_HUGGINGFACE_TOKEN }}"
            prompt: "{{ data.ticket.subject }} {{ data.ticket.body }}"

        # Queue classification workflow
        - &queue_classification_workflow
            id: queue_classification
            steps:
                # Step 1: Fetch tickets from incoming queue
                -   id: ticket_fetcher
                    <<: *ticket_fetch_pipe
                    injects: { ticket_system: "otobo_znuny" }
                    ticket_search_criteria:
                        queue.name: "{{ config.incoming_queue }}"
                        limit: 1

                # Step 2: Classify ticket using AI
                -   if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
                    id: classify_queue
                    <<: *queue_classifier
                    model: "{{ config.queue_model }}"
                    depends_on: [ "ticket_fetcher" ]

                # Step 3: Map AI label to actual queue name
                -   if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
                    id: map_to_queue
                    <<: *jinja_expression_pipe
                    expression: "{{ config.queue_map[get_pipe_result('classify_queue','label')] }}"
                    depends_on: [ "classify_queue" ]

                # Step 4: Determine final queue based on confidence threshold
                -   if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
                    id: select_final_queue
                    <<: *jinja_expression_pipe
                    expression: |
                        {{
                        get_pipe_result('map_to_queue','value') if get_pipe_result('classify_queue','confidence') >= config.min_confidence
                        else config.low_confidence_queue
                        }}
                    depends_on: [ "map_to_queue" ]

                # Step 5: Update ticket with new queue
                -   if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
                    id: update_ticket_queue
                    <<: *default_ticket_update
                    updated_ticket:
                        queue:
                            name: "{{ get_pipe_result('select_final_queue','value') }}"
                    depends_on: [ "select_final_queue" ]

                # Step 6: Add classification note
                -   if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
                    id: add_classification_note
                    <<: *default_ticket_add_note
                    note:
                        subject: "Automatic Queue Classification"
                        body: |
                            This ticket has been automatically classified and moved to queue: {{ get_pipe_result('select_final_queue','value') }}

                            Classification Details:
                            - AI Model: {{ config.queue_model }}
                            - Predicted Category: {{ get_pipe_result('classify_queue','label') }}
                            - Confidence: {{ get_pipe_result('classify_queue','confidence') }}
                            - Minimum Confidence Threshold: {{ config.min_confidence }}

                            {% if get_pipe_result('classify_queue','confidence') < config.min_confidence %}
                            Note: Confidence was below threshold, ticket moved to {{ config.low_confidence_queue }} for manual review.
                            {% endif %}
                    depends_on: [ "update_ticket_queue" ]

    # Orchestrator: Run queue classification every 30 seconds
    orchestrator:
        -   run_every_milli_seconds: 30000
            pipe:
                <<: *queue_classification_workflow
                incoming_queue: "Incoming"
                queue_model: "open-ticket-ai/queue-classification-german-bert"
                min_confidence: 0.8
                low_confidence_queue: "Manual Review"
                queue_map:
                    # Map AI model labels to your actual queue names
                    "IT Support": "IT Support"
                    "HR": "Human Resources"
                    "Finance": "Finance & Accounting"
                    "General": "General Support"
                    "Technical": "Technical Support"
