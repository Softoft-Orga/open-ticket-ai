@startuml Config to Mermaid Conversion Flow
allow_mixing
title Config to Mermaid Diagram Conversion Process

' Input files
package "Input Files" {
  class "config.yml" as config_yml <<file>> #lightblue
  class "config.schema.json" as schema <<file>> #lightgray
}

' Core components
package "Conversion Engine" {
  class ConfigLoader {
    + load_config()
  }
  
  class MermaidGenerator {
    + generate_mermaid_diagram()
  }

  package "Graph Building" {
    class GraphBuilder {
      + nodes: OrderedDict[str, Node]
      + edges: list[tuple]
      + add_node()
      + add_edge()
      + append_to_label()
    }
    
    class ScopedIdMap {
      + _parent: ScopedIdMap
      + _values: dict[str, str]
      + set()
      + get()
    }
    
    class StepBuilder {
      + _build_steps()
    }
  }

  package "Node Processing" {
    class NameProcessor {
      + _determine_display_name()
    }
    
    class LabelFormatter {
      + _format_label()
    }
    
    class IdGenerator {
      + _make_node_identifier()
      + _sanitize_token()
    }
  }

  package "Rendering" {
    class NodeRenderer {
      + _render_node()
    }
    
    class EdgeRenderer {
      + _render_edge()
    }
    
    class TextSanitizer {
      + _sanitize_label_text()
    }
  }
}

' Data structures
package "Data Structures" {
  class Node {
    + identifier: str
    + label: str
    + shape: str
  }
}

' Output
package "Output" {
  class "diagram.mmd" as mermaid_output <<file>> #lightgreen
  note right of mermaid_output : Contains flowchart\nwith nodes and edges
}

' Pipeline structure representation
package "Pipeline Structure Processing" {
  class Orchestrator {
    + extract_pipelines()
  }
  
  class PipeDefinitions {
    + resolve_references()
  }
  
  class Steps {
    + build_step_list()
  }
  
  class Dependencies {
    + create_edges()
  }

  note right of Orchestrator : Each orchestrator entry\nbecomes a pipeline
  note right of PipeDefinitions : Reusable pipe definitions\nwith YAML anchors
  note right of Steps : Sequential/conditional\nexecution steps
  note right of Dependencies : depends_on relationships\ncreate edges
}

' Flow connections
config_yml --> ConfigLoader : parse YAML
schema --> ConfigLoader : validate structure
ConfigLoader --> MermaidGenerator : RawOpenTicketAIConfig

MermaidGenerator --> Orchestrator : extract pipelines
Orchestrator --> PipeDefinitions : resolve references
PipeDefinitions --> Steps : build step list
Steps --> StepBuilder : process recursively

StepBuilder --> GraphBuilder : accumulate nodes/edges
StepBuilder --> ScopedIdMap : track dependencies
StepBuilder --> NameProcessor : determine names
StepBuilder --> LabelFormatter : create labels
StepBuilder --> IdGenerator : generate IDs

NameProcessor --> IdGenerator : clean tokens
LabelFormatter --> Node : create Node objects
IdGenerator --> IdGenerator : clean identifiers

GraphBuilder --> NodeRenderer : format nodes
GraphBuilder --> EdgeRenderer : format edges
NodeRenderer --> TextSanitizer : escape text
EdgeRenderer --> TextSanitizer : escape text

NodeRenderer --> mermaid_output : write nodes
EdgeRenderer --> mermaid_output : write edges

Dependencies --> StepBuilder : create edge connections




@enduml
