# Example: AI-Powered Priority Classification
# 
# This configuration demonstrates automatic priority assignment based on
# AI analysis of ticket urgency and importance. Ensures critical issues
# receive immediate attention.

open_ticket_ai:
  general_config:
    logging:
      version: 1
      disable_existing_loggers: false
      handlers: 
        console: 
          class: logging.StreamHandler
          stream: ext://sys.stdout
      formatters: 
        std: 
          format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
      root: 
        level: INFO
        handlers: [console]

    pipe_classes:
      - &ticket_fetch_pipe
        use: "open_ticket_ai.base:FetchTicketsPipe"
      - &ticket_update_pipe
        use: "open_ticket_ai.base:UpdateTicketsPipe"
      - &ticket_add_note_pipe
        use: "open_ticket_ai.base:AddNoteTicketsPipe"
      - &ticket_classifier_pipe
        use: "open_ticket_ai.hf_local:HFLocalTextClassificationPipe"
      - &jinja_expression_pipe
        use: "open_ticket_ai.base:JinjaExpressionPipe"

  defs:
    # Ticket system connection
    - id: "otobo_znuny"
      use: "open_ticket_ai.otobo_znuny_plugin:OToboZnunyTicketSystemService"
      server_address: "{{ env.OTAI_OTOBO_ZNUNY_SERVER_ADDRESS }}"
      password: "{{ env.OTAI_OTOBO_ZNUNY_PASSWORD }}"

    # Default ticket update pipe
    - &default_ticket_update
      <<: *ticket_update_pipe
      injects: { ticket_system: "otobo_znuny" }
      ticket_id: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | first).id }}"

    # Default note addition pipe
    - &default_ticket_add_note
      <<: *ticket_add_note_pipe
      injects: { ticket_system: "otobo_znuny" }
      ticket_id: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | first).id }}"

    # AI classifier for priority assignment
    - &priority_classifier
      <<: *ticket_classifier_pipe
      token: "{{ env.OTAI_HUGGINGFACE_TOKEN }}"
      prompt: "{{ data.ticket.subject }} {{ data.ticket.body }}"

    # Priority classification workflow
    - &priority_classification_workflow
      id: priority_classification
      steps:
        # Step 1: Fetch tickets that need priority assignment
        - id: ticket_fetcher
          <<: *ticket_fetch_pipe
          injects: { ticket_system: "otobo_znuny" }
          ticket_search_criteria:
            queue.name: "{{ config.target_queue }}"
            priority.name: "{{ config.default_priority }}"
            limit: 1

        # Step 2: Classify priority using AI
        - if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
          id: classify_priority
          <<: *priority_classifier
          model: "{{ config.priority_model }}"
          depends_on: ["ticket_fetcher"]

        # Step 3: Map AI label to actual priority name
        - if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
          id: map_to_priority
          <<: *jinja_expression_pipe
          expression: "{{ config.priority_map[get_pipe_result('classify_priority','label')] }}"
          depends_on: ["classify_priority"]

        # Step 4: Determine final priority based on confidence
        - if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
          id: select_final_priority
          <<: *jinja_expression_pipe
          expression: |
            {{
            get_pipe_result('map_to_priority','value') if get_pipe_result('classify_priority','confidence') >= config.min_confidence
            else config.low_confidence_priority
            }}
          depends_on: ["map_to_priority"]

        # Step 5: Update ticket with new priority
        - if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
          id: update_ticket_priority
          <<: *default_ticket_update
          updated_ticket:
            priority:
              name: "{{ get_pipe_result('select_final_priority','value') }}"
          depends_on: ["select_final_priority"]

        # Step 6: Add classification note
        - if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
          id: add_priority_note
          <<: *default_ticket_add_note
          note:
            subject: "Automatic Priority Assignment"
            body: |
              This ticket's priority has been automatically set to: {{ get_pipe_result('select_final_priority','value') }}
              
              Priority Classification Details:
              - AI Model: {{ config.priority_model }}
              - Predicted Priority: {{ get_pipe_result('classify_priority','label') }}
              - Confidence: {{ get_pipe_result('classify_priority','confidence') }}
              - Minimum Confidence Threshold: {{ config.min_confidence }}
              
              {% if get_pipe_result('classify_priority','confidence') < config.min_confidence %}
              Note: Confidence was below threshold ({{ get_pipe_result('classify_priority','confidence') }} < {{ config.min_confidence }}), 
              using default priority {{ config.low_confidence_priority }} for manual review.
              {% endif %}
              
              {% if get_pipe_result('select_final_priority','value') in ['1 Very High', '2 High'] %}
              ⚠️ This ticket has been marked as high priority. Please address promptly.
              {% endif %}
          depends_on: ["update_ticket_priority"]

  # Orchestrator: Run priority classification every 45 seconds
  orchestrator:
    - run_every_milli_seconds: 45000
      pipe:
        <<: *priority_classification_workflow
        target_queue: "IT Support"
        default_priority: "3 Normal"
        priority_model: "open-ticket-ai/priority-classification-german-bert"
        min_confidence: 0.75
        low_confidence_priority: "3 Normal"
        priority_map:
          # Map AI model labels to your actual priority names
          "Critical": "1 Very High"
          "High": "2 High"
          "Medium": "3 Normal"
          "Low": "4 Low"
          "Very Low": "5 Very Low"
