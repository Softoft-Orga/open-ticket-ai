# Example: AI Adds Note to Ticket When in Specific Queue
#
# This configuration demonstrates how to automatically add AI-generated notes
# to tickets when they enter a specific queue (e.g., "Support" queue).
# The AI analyzes the ticket content and adds helpful context or suggestions.

open_ticket_ai:
    general_config:
        logging:
            version: 1
            disable_existing_loggers: false
            handlers:
                console:
                    class: logging.StreamHandler
                    stream: ext://sys.stdout
            formatters:
                std:
                    format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
            root:
                level: INFO
                handlers: [ console ]

        pipe_classes:
            - &ticket_fetch_pipe
                use: "open_ticket_ai.base:FetchTicketsPipe"
            - &ticket_add_note_pipe
                use: "open_ticket_ai.base:AddNoteTicketsPipe"
            - &ticket_classifier_pipe
                use: "open_ticket_ai.open_ticket_ai_hf_local:HFLocalTextClassificationPipe"
            - &jinja_expression_pipe
                use: "open_ticket_ai.base:JinjaExpressionPipe"

    defs:
        # Ticket system connection
        -   id: "otobo_znuny"
            use: "open_ticket_ai.open_ticket_ai_otobo_znuny_plugin:OToboZnunyTicketSystemService"
            server_address: "{{ env.OTAI_OTOBO_ZNUNY_SERVER_ADDRESS }}"
            password: "{{ env.OTAI_OTOBO_ZNUNY_PASSWORD }}"

        # Default note addition pipe
        - &default_ticket_add_note
            <<: *ticket_add_note_pipe
            injects: { ticket_system: "otobo_znuny" }
            ticket_id: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | first).id }}"

        # AI classifier for analyzing ticket content
        - &ticket_analyzer
            <<: *ticket_classifier_pipe
            token: "{{ env.OTAI_HUGGINGFACE_TOKEN }}"
            prompt: "{{ data.ticket.subject }} {{ data.ticket.body }}"

        # Pipeline definition for adding notes based on queue
        - &add_note_to_support_queue
            id: add_note_workflow
            steps:
                # Step 1: Fetch tickets from Support queue
                -   id: ticket_fetcher
                    <<: *ticket_fetch_pipe
                    injects: { ticket_system: "otobo_znuny" }
                    ticket_search_criteria:
                        queue.name: "Support"
                        limit: 10

                # Step 2: Only proceed if tickets were found
                -   if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
                    id: analyze_ticket
                    <<: *ticket_analyzer
                    model: "distilbert/distilbert-base-uncased-finetuned-sst-2-english"

                # Step 3: Generate note content based on analysis
                -   if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
                    id: generate_note_content
                    <<: *jinja_expression_pipe
                    expression: |
                        Analysis Result: {{ get_pipe_result('analyze_ticket','label') }}
                        Confidence: {{ get_pipe_result('analyze_ticket','confidence') }}

                        Based on the automated analysis, this ticket appears to have a {{ get_pipe_result('analyze_ticket','label') }} sentiment.

                        Suggested actions:
                        {% if get_pipe_result('analyze_ticket','label') == 'NEGATIVE' %}
                        - Priority escalation may be needed
                        - Consider immediate response
                        - Check for urgency indicators
                        {% elif get_pipe_result('analyze_ticket','label') == 'POSITIVE' %}
                        - Standard response time applies
                        - Customer appears satisfied or neutral
                        {% else %}
                        - Standard processing recommended
                        {% endif %}
                    depends_on: [ "analyze_ticket" ]

                # Step 4: Add the generated note to the ticket
                -   if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
                    id: add_analysis_note
                    <<: *default_ticket_add_note
                    note:
                        subject: "Automated AI Analysis"
                        body: "{{ get_pipe_result('generate_note_content','value') }}"
                    depends_on: [ "generate_note_content" ]

    # Orchestrator: Run this workflow every 60 seconds
    orchestrator:
        -   run_every_milli_seconds: 60000
            pipe:
                <<: *add_note_to_support_queue
