# Example: Complete AI Workflow with Queue, Priority, and Notes
#
# This comprehensive configuration combines multiple AI operations:
# - Automatic queue classification
# - Priority assignment
# - AI-generated contextual notes
# - Error handling and fallback mechanisms
#
# This is a production-ready example showing the full power of Open Ticket AI.

open_ticket_ai:
  general_config:
    logging:
      version: 1
      disable_existing_loggers: false
      handlers:
        console:
          class: logging.StreamHandler
          stream: ext://sys.stdout
      formatters:
        std:
          format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
      root:
        level: INFO
        handlers: [console]

    pipe_classes:
      - &ticket_fetch_pipe
        use: "open_ticket_ai.base:FetchTicketsPipe"
      - &ticket_update_pipe
        use: "open_ticket_ai.base:UpdateTicketsPipe"
      - &ticket_add_note_pipe
        use: "open_ticket_ai.base:AddNoteTicketsPipe"
      - &ticket_classifier_pipe
        use: "open_ticket_ai.open_ticket_ai_hf_local:HFLocalTextClassificationPipe"
      - &jinja_expression_pipe
        use: "open_ticket_ai.base:JinjaExpressionPipe"

  defs:
    # Ticket system connection
    - id: "otobo_znuny"
      use: "open_ticket_ai.open_ticket_ai_otobo_znuny_plugin:OToboZnunyTicketSystemService"
      server_address: "{{ env.OTAI_OTOBO_ZNUNY_SERVER_ADDRESS }}"
      password: "{{ env.OTAI_OTOBO_ZNUNY_PASSWORD }}"

    # Default ticket update pipe
    - &default_ticket_update
      <<: *ticket_update_pipe
      injects: { ticket_system: "otobo_znuny" }
      ticket_id: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | first).id }}"

    # Default note addition pipe
    - &default_ticket_add_note
      <<: *ticket_add_note_pipe
      injects: { ticket_system: "otobo_znuny" }
      ticket_id: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | first).id }}"

    # AI classifier template
    - &ticket_classifier
      <<: *ticket_classifier_pipe
      token: "{{ env.OTAI_HUGGINGFACE_TOKEN }}"
      prompt: "{{ data.ticket.subject }} {{ data.ticket.body }}"

    # Generic classification step (reusable for queue/priority)
    - &classification_generic
      id: classification_generic
      steps:
        # Classify using AI
        - id: classify
          <<: *ticket_classifier
          model: "{{ config.model }}"

        # Map AI label to system value
        - id: map_value
          <<: *jinja_expression_pipe
          expression: "{{ config.map_obj[get_pipe_result('classify','label')] }}"
          depends_on: ["classify"]

        # Select final value based on confidence
        - id: select_final
          <<: *jinja_expression_pipe
          expression: |
            {{
            get_pipe_result('map_value','value') if get_pipe_result('classify','confidence') >= config.min_conf
            else config.low_conf_name
            }}
          depends_on: ["map_value"]

        # Update ticket
        - id: update_ticket
          <<: *default_ticket_update
          updated_ticket: "{{ get_pipe_result('select_final','value') | at_path(config.ticket_field) }}"
          depends_on: ["select_final"]

        # Add note about the classification
        - id: add_note
          <<: *default_ticket_add_note
          note: |
            {{
            config.note_high.body if get_pipe_result('classify','confidence') >= config.min_conf
            else config.note_low.body
            }}
          depends_on: ["update_ticket"]

        # Error handling: Update on failure
        - if: "{{ has_failed('update_ticket') and config.update_on_error }}"
          <<: *default_ticket_update
          updated_ticket: "{{ config.on_error_update_value | at_path(config.ticket_field) }}"
          depends_on: ["update_ticket"]

        # Error handling: Add error note
        - if: "{{ has_failed('update_ticket') and config.error_note }}"
          <<: *default_ticket_add_note
          note: "{{ config.error_note }}"
          depends_on: ["update_ticket"]

    # Complete ticket routing workflow
    - &ticket_routing_workflow
      id: ticket_routing
      steps:
        # Step 1: Fetch new tickets from incoming queue
        - id: ticket_fetcher
          <<: *ticket_fetch_pipe
          injects: { ticket_system: "otobo_znuny" }
          ticket_search_criteria: "{{ config.ticket_search_criteria }}"

        # Step 2: Queue Classification
        - if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
          id: queue_classification
          <<: *classification_generic
          model: "{{ config.queue_model }}"
          map_obj: "{{ config.queue_map }}"
          min_conf: "{{ config.min_queue_confidence }}"
          low_conf_name: "{{ config.low_confidence_queue_name }}"
          ticket_field: "queue.name"
          note_high:
            subject: "Automatic Queue Classification"
            body: |
              ✓ Ticket automatically classified to queue: {{ get_pipe_result('select_final','value') }}

              Classification Details:
              - Predicted Category: {{ get_pipe_result('classify','label') }}
              - Confidence: {{ (get_pipe_result('classify','confidence') * 100) | round(2) }}%
              - Model: {{ config.queue_model }}
          note_low:
            subject: "Automatic Queue Classification - Low Confidence"
            body: |
              ⚠️ Ticket classified to queue: {{ get_pipe_result('select_final','value') }}

              Note: Low confidence classification. Manual review recommended.

              Classification Details:
              - Predicted Category: {{ get_pipe_result('classify','label') }}
              - Confidence: {{ (get_pipe_result('classify','confidence') * 100) | round(2) }}%
              - Threshold: {{ (config.min_queue_confidence * 100) | round(2) }}%
              - Model: {{ config.queue_model }}
          update_on_error: true
          on_error_update_value: "{{ config.error_queue_name }}"
          error_note:
            subject: "Queue Classification Error"
            body: |
              ❌ Error during automatic queue classification.
              Ticket moved to {{ config.error_queue_name }} for manual handling.

        # Step 3: Priority Classification
        - if: "{{ (get_pipe_result('ticket_fetcher','fetched_tickets') | length) > 0 }}"
          id: priority_classification
          <<: *classification_generic
          model: "{{ config.priority_model }}"
          map_obj: "{{ config.priority_map }}"
          min_conf: "{{ config.min_priority_confidence }}"
          low_conf_name: "{{ config.low_confidence_priority_name }}"
          ticket_field: "priority.name"
          note_high:
            subject: "Automatic Priority Assignment"
            body: |
              ✓ Priority automatically set to: {{ get_pipe_result('select_final','value') }}

              Classification Details:
              - Predicted Priority: {{ get_pipe_result('classify','label') }}
              - Confidence: {{ (get_pipe_result('classify','confidence') * 100) | round(2) }}%
              - Model: {{ config.priority_model }}

              {% if get_pipe_result('select_final','value') in ['1 Very High', '2 High'] %}
              ⚠️ HIGH PRIORITY: Please address this ticket promptly.
              {% endif %}
          note_low:
            subject: "Automatic Priority Assignment - Low Confidence"
            body: |
              ⚠️ Priority set to: {{ get_pipe_result('select_final','value') }}

              Note: Low confidence classification. Manual review recommended.

              Classification Details:
              - Predicted Priority: {{ get_pipe_result('classify','label') }}
              - Confidence: {{ (get_pipe_result('classify','confidence') * 100) | round(2) }}%
              - Threshold: {{ (config.min_priority_confidence * 100) | round(2) }}%
              - Model: {{ config.priority_model }}
          error_note:
            subject: "Priority Classification Error"
            body: |
              ❌ Error during automatic priority classification.
              Default priority maintained.

  # Orchestrator: Run complete workflow every 10 seconds
  orchestrator:
    - run_every_milli_seconds: 10000
      pipe:
        <<: *ticket_routing_workflow
        ticket_search_criteria:
          queue.name: "Incoming"
          limit: 1

        # Queue Classification Settings
        min_queue_confidence: 0.8
        queue_model: "open-ticket-ai/queue-classification-german-bert"
        low_confidence_queue_name: "Manual Review"
        error_queue_name: "Error Queue"
        queue_map:
          "IT Support": "IT Support"
          "HR": "Human Resources"
          "Finance": "Finance"
          "General": "General Support"

        # Priority Classification Settings
        min_priority_confidence: 0.75
        priority_model: "open-ticket-ai/priority-classification-german-bert"
        low_confidence_priority_name: "3 Normal"
        priority_map:
          "Critical": "1 Very High"
          "High": "2 High"
          "Medium": "3 Normal"
          "Low": "4 Low"
          "Very Low": "5 Very Low"
