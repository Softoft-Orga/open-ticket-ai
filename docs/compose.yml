services:
    open-ticket-ai:
        image: softotobo/open-ticket-ai:otobo-znuny-mvp
        restart: "always"
        volumes:
            - ./config.yml:/app/config.yml:ro
    postgres:
        image: postgres:14
        environment:
            POSTGRES_USER: prefect
            POSTGRES_PASSWORD: prefect
            POSTGRES_DB: prefect
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U prefect" ]
            interval: 5s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7
        volumes:
            - redis_data:/data
        healthcheck:
            test: [ "CMD-SHELL", "redis-cli ping" ]
            interval: 5s
            timeout: 5s
            retries: 5

    prefect-server:
        image: prefecthq/prefect:3-latest
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        environment:
            PREFECT_API_DATABASE_CONNECTION_URL: postgresql+asyncpg://prefect:prefect@postgres:5432/prefect
            PREFECT_SERVER_API_HOST: 0.0.0.0
            PREFECT_MESSAGING_BROKER: prefect_redis.messaging
            PREFECT_MESSAGING_CACHE: prefect_redis.messaging
            PREFECT_REDIS_MESSAGING_HOST: redis
            PREFECT_REDIS_MESSAGING_PORT: 6379
            PREFECT_REDIS_MESSAGING_DB: 0
        command: prefect server start --no-services
        ports:
            - "4200:4200"
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:4200/api/health || exit 1"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    prefect-services:
        image: prefecthq/prefect:3-latest
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
        environment:
            PREFECT_API_DATABASE_CONNECTION_URL: postgresql+asyncpg://prefect:prefect@postgres:5432/prefect
            PREFECT_MESSAGING_BROKER: prefect_redis.messaging
            PREFECT_MESSAGING_CACHE: prefect_redis.messaging
            PREFECT_REDIS_MESSAGING_HOST: redis
            PREFECT_REDIS_MESSAGING_PORT: 6379
            PREFECT_REDIS_MESSAGING_DB: 0
        command: prefect server services start

    prefect-init:
        image: prefecthq/prefect:3-latest
        depends_on:
            prefect-server:
                condition: service_healthy
        environment:
            PREFECT_API_URL: http://prefect-server:4200/api
        command: >
            sh -c "
            echo 'Waiting for Prefect server to be ready...';
            sleep 5;
            echo 'Creating default work pool...';
            prefect work-pool create default --type process || echo 'Work pool already exists';
            echo 'Work pool setup complete';
            "
        restart: "no"

    prefect-worker:
        image: prefecthq/prefect:3-latest
        depends_on:
            prefect-server:
                condition: service_healthy
            prefect-init:
                condition: service_completed_successfully
        environment:
            PREFECT_API_URL: http://prefect-server:4200/api
        command: prefect worker start --pool default

volumes:
    postgres_data:
    redis_data:
