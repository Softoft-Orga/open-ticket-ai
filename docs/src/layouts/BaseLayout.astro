---
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import NavBar from '../components/vue/core/navigation/NavBar.vue';
import FooterComponent from '../components/FooterComponent.astro';
import CookieBanner from '../components/vue/core/basic/CookieBanner.vue';
import '../styles/global.css';
import ModalTrigger from '../components/vue/core/basic/ModalTrigger.vue';
import ContactForm from '../components/ContactForm.astro';
import Button from '../components/vue/core/basic/Button.vue';

interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;
const gaIds = ['AW-474755810', 'G-FBWC3JDZJ4'];

// Load site configuration for current locale
const currentLocale = (Astro.currentLocale || 'en').toLowerCase();
const allSiteConfigs = await getCollection('site');
const siteConfig = allSiteConfigs.find(entry =>
  entry.id.toLowerCase().startsWith(`${currentLocale}/`)
);

// Localize URLs from site config
const navLinks = (siteConfig?.data.nav || []).map(link => ({
  ...link,
  url: getRelativeLocaleUrl(Astro.currentLocale || 'en', link.url),
}));

const footerData = siteConfig?.data.footer
  ? {
      ...siteConfig.data.footer,
      sections: siteConfig.data.footer.sections.map(section => ({
        ...section,
        links: section.links.map(link => ({
          ...link,
          url:
            link.url.startsWith('#') || link.url.startsWith('http')
              ? link.url
              : getRelativeLocaleUrl(Astro.currentLocale || 'en', link.url),
        })),
      })),
    }
  : undefined;

const logoUrl = siteConfig?.data.meta.logoUrl;
const ctaLabel = 'Contact Sales';
const ctaUrl = getRelativeLocaleUrl(Astro.currentLocale || 'en', 'products');

// Cookie banner localization
const cookieBannerTexts = {
  en: {
    title: 'We value your privacy',
    description:
      'We use cookies and analytics to improve your experience and understand how you use our website. For more information, please read our',
    privacyPolicyText: 'Privacy Policy',
    acceptText: 'Accept',
    declineText: 'Decline',
  },
  de: {
    title: 'Wir schätzen Ihre Privatsphäre',
    description:
      'Wir verwenden Cookies und Analytics, um Ihre Erfahrung zu verbessern und zu verstehen, wie Sie unsere Website nutzen. Weitere Informationen finden Sie in unserer',
    privacyPolicyText: 'Datenschutzerklärung',
    acceptText: 'Akzeptieren',
    declineText: 'Ablehnen',
  },
};

const cookieTexts =
  cookieBannerTexts[currentLocale as keyof typeof cookieBannerTexts] || cookieBannerTexts.en;
const privacyPolicyUrl = getRelativeLocaleUrl(Astro.currentLocale || 'en', 'company/data-privacy');
---

<!doctype html>
<html lang={Astro.currentLocale} data-locale={Astro.currentLocale}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Google Analytics - only loads after cookie consent -->
    <script is:inline define:vars={{ gaIds }}>
      (() => {
        const CONSENT_STORAGE_KEY = 'cookie-consent';
        const CONSENT_ACCEPTED = 'accepted';
        let loaded = false;

        function loadGoogleAnalytics() {
          if (loaded) return;
          loaded = true;

          const s = document.createElement('script');
          s.src = 'https://www.googletagmanager.com/gtag/js?id=' + gaIds[0];
          s.async = true;
          document.head.appendChild(s);

          window.dataLayer = window.dataLayer || [];

          function gtag(...args) {
            dataLayer.push(...args);
          }

          gtag('js', new Date());
          gaIds.forEach(id => {
            gtag('config', id, { send_page_view: false });
          });
        }

        function checkConsentAndLoad() {
          try {
            const consent = localStorage.getItem(CONSENT_STORAGE_KEY);
            if (consent === CONSENT_ACCEPTED) {
              loadGoogleAnalytics();
            }
          } catch (error) {
            console.error('Failed to check cookie consent:', error);
          }
        }

        // Check consent on page load
        checkConsentAndLoad();

        // Listen for consent changes
        window.addEventListener('cookie-consent-changed', function (event) {
          if (event.detail && event.detail.consent === CONSENT_ACCEPTED) {
            loadGoogleAnalytics();
          }
        });
      })();
    </script>
  </head>
  <body class="font-sans">
    <NavBar client:load links={navLinks} logoUrl={logoUrl} ctaUrl={ctaUrl}>
      <ModalTrigger
        title="Contact Sales"
        tone="neutral"
        size="lg"
        button-text={ctaLabel}
        button-variant="surface"
        button-tone="primary"
        button-size="md"
        button-block
        client:load
      >
        <ContactForm
          title="Contact Sales"
          submitButtonText="Submit"
          messageLabel="Message"
          emailLabel="Email"
          subjectLabel="Subject"
          emailPlaceholder="your@email.com"
          messagePlaceholder="How can we help you?"
          successActionUrl="/success/contact-sales"
          name="contact-sales"
        />
      </ModalTrigger>
    </NavBar>
    <slot />
    <FooterComponent footerData={footerData} />
    <CookieBanner
      client:load
      title={cookieTexts.title}
      description={cookieTexts.description}
      acceptText={cookieTexts.acceptText}
      declineText={cookieTexts.declineText}
      privacyPolicyText={cookieTexts.privacyPolicyText}
      privacyPolicyUrl={privacyPolicyUrl}
    />
  </body>
</html>
