---
import { getCollection } from 'astro:content';
import { getRelativeLocaleUrl } from 'astro:i18n';
import NavBar from '../components/vue/core/navigation/NavBar.vue';
import FooterComponent from '../components/vue/core/navigation/FooterComponent.vue';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;
const gaIds = ['AW-474755810', 'G-FBWC3JDZJ4'];

// Get current locale from Astro
const currentLocale = Astro.currentLocale || 'en';

// Load site configuration
const siteEntries = await getCollection('site');
const siteConfig = siteEntries.find(entry => entry.data.slug === 'main');

// Helper to add trailing slash and localize URL
const localizeUrl = (url: string) => {
  // Don't localize external URLs or hash links
  if (url.startsWith('http') || url.startsWith('#')) {
    return url;
  }
  // Ensure trailing slash for internal links
  const urlWithSlash = url.endsWith('/') ? url : url + '/';
  // Use Astro's getRelativeLocaleUrl to create locale-aware URL
  return getRelativeLocaleUrl(currentLocale, urlWithSlash);
};

// Localize navigation links
const navLinks = (siteConfig?.data.nav || []).map(link => ({
  ...link,
  url: localizeUrl(link.url),
}));

// Localize footer links
const footerData = siteConfig?.data.footer ? {
  ...siteConfig.data.footer,
  sections: siteConfig.data.footer.sections.map(section => ({
    ...section,
    links: section.links.map(link => ({
      ...link,
      url: localizeUrl(link.url),
    })),
  })),
  legal: siteConfig.data.footer.legal.map(link => ({
    ...link,
    url: localizeUrl(link.url),
  })),
} : undefined;

const logoUrl = siteConfig?.data.meta.logoUrl;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <slot name="head" />

    <!-- Google Analytics lazy loading -->
    <script is:inline define:vars={{ gaIds }}>
      (() => {
        let loaded = false;
        function load() {
          if (loaded) return;
          loaded = true;
          const s = document.createElement('script');
          s.src = 'https://www.googletagmanager.com/gtag/js?id=' + gaIds[0];
          s.async = true;
          document.head.appendChild(s);
          window.dataLayer = window.dataLayer || [];
          /* eslint-disable @typescript-eslint/no-explicit-any */
          function gtag(...args: any[]) {
            dataLayer.push(...args);
          }
          /* eslint-enable @typescript-eslint/no-explicit-any */
          gtag('js', new Date());
          gaIds.forEach((id) => {
            gtag('config', id, { send_page_view: false });
          });
        }
        if ('requestIdleCallback' in window) {
          requestIdleCallback(load, { timeout: 4000 });
        } else {
          setTimeout(load, 2000);
        }
        let fired = false;
        ['scroll', 'pointerdown', 'keydown', 'touchstart'].forEach((ev) => {
          addEventListener(
            ev,
            function () {
              if (fired) return;
              fired = true;
              load();
            },
            { passive: true, once: true }
          );
        });
      })();
    </script>
  </head>
  <body class="font-sans">
    <NavBar client:load links={navLinks} logoUrl={logoUrl} />
    <slot />
    <FooterComponent client:load footerData={footerData} />
  </body>
</html>
