---
// Custom head component for Google Analytics
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Head.astro';

const gaId = 'G-FBWC3JDZJ4';
---

<Default {...Astro.props}><slot /></Default>

<!-- Google Analytics lazy loading -->
<script is:inline define:vars={{ gaId }}>
  (() => {
    let loaded = false;
    function load() {
      if (loaded) return;
      loaded = true;
      const s = document.createElement('script');
      s.src = 'https://www.googletagmanager.com/gtag/js?id=' + gaId;
      s.async = true;
      document.head.appendChild(s);
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', gaId, { send_page_view: false });
    }
    if ('requestIdleCallback' in window) {
      requestIdleCallback(load, { timeout: 4000 });
    } else {
      setTimeout(load, 2000);
    }
    let fired = false;
    ['scroll', 'pointerdown', 'keydown', 'touchstart'].forEach((ev) => {
      addEventListener(
        ev,
        function () {
          if (fired) return;
          fired = true;
          load();
        },
        { passive: true, once: true }
      );
    });
  })();
</script>
